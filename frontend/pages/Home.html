<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TacoBell - Live Más</title>
    <link rel="stylesheet" href="/frontend/pages/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <div class="logo">Taco<span>bel</span> do <span>Cego</span></div>
      <p><span>Viva mais</span></p>
    </header>

    <div class="menu-toggle" id="menuToggle">☰</div>
    <nav id="mainNav">
      <a href="#menu">Menu</a>
      <a href="location.html">Locais</a>
      <a href="rewards.html">Bônus</a>
      <a href="about.html">Sobre nós</a>
      <a href="login.html">Login</a>
      <a href="#contact">Contatos</a>
      <a href="#" id="cartBtn"
        ><img
          class="scart"
          src="../imagens/shop-cart-svgrepo-com (1).svg"
          alt="cart"
      /></a>
    </nav>

    <section class="hero">
      <div class="hero-content">
        <h1>Novo Crunchwrap Supreme</h1>
        <p>Experimente nossa mais nova adição ao menu - repleta de sabor!</p>
        <a href="#menu" class="btn">Peça agora</a>
      </div>
    </section>

    <section class="menu" id="menu">
      <h2>Nosso Menu</h2>
      <div class="menu-items">
        <div class="menu-item">
          <img
            class="itemimg"
            src="/frontend/imagens/food1.jpg"
            alt="Crunchwrap Supreme"
          />
          <div class="item-info">
            <h3>Crunchwrap Supreme</h3>
            <p>
              Uma tortilha de farinha coberta com carne temperada, molho de
              queijo nacho quente, uma torrada crocante, alface crocante,
              tomates maduros e coberta com creme de leite fresco com baixo teor
              de gordura.
            </p>
            <p id="crunchwrap-price" class="price">texto</p>
            <div class="addcart">
              <button class="add-butão" onclick="add()">
                Adicionar no carrinho
              </button>
            </div>
          </div>
        </div>

        <div class="menu-item">
          <img
            class="itemimg"
            src="/frontend/imagens/food2.jpg"
            alt="Chalupa"
          />
          <div class="item-info">
            <h3>Chalupa Supreme</h3>
            <p>
              Feita com milho recheada com carne temperada, alface crocante,
              queijo cheddar, tomates maduros e coberta com creme de leite
              fresco com baixo teor de gordura.
            </p>
            <div>
              <p id="chalupa-price" class="price">$2.99</p>
            </div>
            <div class="addcart">
              <button class="add-butão" onclick="add()">
                Adicionar no carrinho
              </button>
            </div>
          </div>
        </div>

        <div id="cartPanel">
          <div class="cart-header">
            <h2 class="cart">Seu Carrinho</h2>
            <button id="closeCart">&times;</button>
          </div>
          <div class="cart-content">
            <p>Seu carrinho está vazio.</p>
          </div>
          <button class="compra">comprar</button>
        </div>

        <div class="menu-item">
          <img
            class="itemimg"
            src="/frontend/imagens/food3.webp"
            alt="Nacho Fries"
          />
          <div class="item-info">
            <h3>Nacho Fries</h3>
            <p>
              Batatas fritas temperadas cobertas com molho de queijo nacho
              quente e servidas com um acompanhamento de molho ranch picante
            </p>
            <div>
              <p id="nacho-price" class="price">$1.99</p>
            </div>
            <div class="addcart">
              <button class="add-butão" onclick="add()">
                Adicionar no carrinho
              </button>
            </div>
          </div>
        </div>

        <div class="menu-item">
          <img
            class="itemimg"
            src="/frontend/imagens/food4.jpg"
            alt="Quesarito"
          />
          <div class="item-info">
            <h3>Quesarito</h3>
            <p>
              Um burrito recheado com carne temperada, molho cremoso de
              chipotle, creme de leite com baixo teor de gordura, molho de
              queijo nacho e envolto em uma quesadilla.
            </p>
            <div>
              <p id="quesarito-price" class="price">$3.49</p>
            </div>
            <div class="addcart">
              <button class="add-butão" onclick="add()">
                Adicionar no carrinho
              </button>
            </div>
          </div>
        </div>

        <div class="menu-item">
          <img
            class="itemimg"
            src="/frontend/imagens/food15.jpg"
            alt="Baja Blast"
            style="width: auto"
          />
          <div class="item-info">
            <h3>Baja Blast Freeze</h3>
            <p>
              Nosso sabor exclusivo Mountain Dew Baja Blast em formato de
              granizado congelado.
            </p>
            <div>
              <p id="baja-price" class="price">$2.49</p>
            </div>
            <div class="addcart">
              <button class="add-butão" onclick="add()">
                Adicionar no carrinho
              </button>
            </div>
          </div>
        </div>

        <div class="menu-item">
          <img
            class="itemimg"
            src="/frontend/imagens/food6.jpg"
            alt="Cinnamon Twists"
          />
          <div class="item-info">
            <h3>Cinnamon Twists</h3>
            <p>Torcidas leves e crocantes cobertas com açúcar e canela</p>
            <div>
              <p id="cinnamon-price" class="price">$1.49</p>
            </div>
            <div class="addcart">
              <button class="add-butão" onclick="add()">
                Adicionar no carrinho
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer id="contact">
      <div class="social-icons">
        <a href="#"><i class="fab fa-facebook"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        <a href="#"><i class="fab fa-tiktok"></i></a>
      </div>
      <p class="footer">&copy; 2023 TacoBell. All rights reserved.</p>
      <p class="footer">Viva mais</p>
    </footer>

    <script>
      const crunchwrap_price = document.getElementById("crunchwrap-price");
      const quesarito_price = document.getElementById("quesarito-price");
      const cinnamon_price = document.getElementById("cinnamon-price");
      const chalupa_price = document.getElementById("chalupa-price");
      const nacho_price = document.getElementById("nacho-price");
      const baja_price = document.getElementById("baja-price");

      async function fetchData() {
        try {
          const response = await fetch(
            "http://172.17.9.73:3000/api/crunchwrap",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({}), // ok vazio
            }
          );

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();
          const price = parseFloat(data.mensagem);
          crunchwrap_price.textContent = data.mensagem;
        } catch (err) {
          console.error("Falha no fetch:", err);
          crunchwrap_price.textContent = "Erro ao carregar o conteúdo.";
        }
        try {
          const response = await fetch("http://172.17.9.73:3000/api/chalupa", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}), // ok vazio
          });

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();
          chalupa_price.textContent = data.mensagem;
        } catch (err) {
          console.error("Falha no fetch:", err);
          chalupa_price.textContent = "Erro ao carregar o conteúdo.";
        }
        try {
          const response = await fetch("http://172.17.9.73:3000/api/nacho", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}), // ok vazio
          });

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();
          nacho_price.textContent = data.mensagem;
        } catch (err) {
          console.error("Falha no fetch:", err);
          nacho_price.textContent = "Erro ao carregar o conteúdo.";
        }
        try {
          const response = await fetch(
            "http://172.17.9.73:3000/api/quesarito",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({}), // ok vazio
            }
          );

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();
          quesarito_price.textContent = data.mensagem;
        } catch (err) {
          console.error("Falha no fetch:", err);
          quesarito_price.textContent = "Erro ao carregar o conteúdo.";
        }
        try {
          const response = await fetch("http://172.17.9.73:3000/api/baja", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}), // ok vazio
          });

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();
          baja_price.textContent = data.mensagem;
        } catch (err) {
          console.error("Falha no fetch:", err);
          baja_price.textContent = "Erro ao carregar o conteúdo.";
        }
        try {
          const response = await fetch("http://172.17.9.73:3000/api/cinnamon", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}), // ok vazio
          });

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();
          cinnamon_price.textContent = data.mensagem;
        } catch (err) {
          console.error("Falha no fetch:", err);
          cinnamon_price.textContent = "Erro ao carregar o conteúdo.";
        }
      }

      fetchData();

      document
        .getElementById("menuToggle")
        .addEventListener("click", function () {
          document.getElementById("mainNav").classList.toggle("active");
        });

      document.addEventListener("DOMContentLoaded", function () {
        const menuItems = document.querySelectorAll(".menu-item");

        menuItems.forEach((item, index) => {
          item.style.transitionDelay = `${index * 0.1}s`;
        });
      });

      // --- hero config (same as yours, keep it) ---
      const heroTexts = [
        {
          title: "New Crunchwrap Supreme",
          subtitle:
            "Experimente nossa mais nova adição ao menu - repleta de sabor!",
        },
        {
          title: "", // will be filled by API
          subtitle: "Oferta de tempo limitado - aproveite enquanto duram!",
        },
        {
          title: "Bebida grátis com qualquer refeição",
          subtitle: "Use o codigo FREEDRINK na finalização da compra",
        },
      ];

      // --- helpers: parse any price the API might send ---
      function coerceNumber(val) {
        if (typeof val === "number") return val;
        if (typeof val === "string") {
          // strip any currency symbols/spaces; kill thousands '.'; turn ',' into '.'
          const cleaned = val
            .replace(/[^\d.,-]/g, "") // keep only digits, comma, dot, minus
            .replace(/\.(?=\d{3}\b)/g, "") // drop thousands dots: 1.234 -> 1234
            .replace(",", "."); // decimal comma -> dot
          const n = Number(cleaned);
          return Number.isNaN(n) ? null : n;
        }
        return null;
      }

      function extractPrice(obj) {
        // try common keys first
        const keys = ["mensagem", "message", "price", "valor", "amount"];
        for (const k of keys) {
          if (k in obj) {
            const n = coerceNumber(obj[k]);
            if (n != null) return n;
          }
        }
        // fallback: find first numeric token anywhere in the payload
        const m = JSON.stringify(obj).match(/-?\d+(?:[.,]\d+)?/);
        if (m) {
          const n = coerceNumber(m[0]);
          if (n != null) return n;
        }
        throw new Error("No numeric price found in API payload");
      }

      // --- fetch + inject into heroTexts ---
      async function loadHeroNacho() {
        try {
          const response = await fetch("http://172.17.9.73:3000/api/nacho", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}), // send whatever payload your API expects
          });

          if (!response.ok) {
            const body = await response.text();
            throw new Error(`HTTP ${response.status} - ${body}`);
          }

          const data = await response.json();

          // try to parse number from API string
          const price = parseFloat(
            String(data.mensagem)
              .replace(/[^\d.,]/g, "")
              .replace(",", ".")
          );

          const formatted = price.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          });

          heroTexts[1].title = `${formatted} Nacho Fries`;
          renderHero(); // update the UI
        } catch (err) {
          console.error("Failed to fetch nacho price:", err);
          heroTexts[1].title = "Preço indisponível";
          renderHero();
        }
      }

      // --- minimal render (if you don’t already have one) ---
      function renderHero() {
        // Replace this with your actual rendering.
        // Example: put the titles into elements with these IDs/data-attrs.
        const el2 = document.querySelector('[data-hero="card-2-title"]');
        const el2sub = document.querySelector('[data-hero="card-2-subtitle"]');

        if (el2) el2.textContent = heroTexts[1].title;
        if (el2sub) el2sub.textContent = heroTexts[1].subtitle;
      }

      // --- bootstrap ---
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await loadHeroNacho();
        } catch (e) {
          console.error(e);
          heroTexts[1].title = "Preço indisponível";
        }
        renderHero();
      });

      let currentHeroIndex = 0;
      const heroTitle = document.querySelector(".hero h1");
      const heroSubtitle = document.querySelector(".hero p");

      function changeHeroText() {
        currentHeroIndex = (currentHeroIndex + 1) % heroTexts.length;
        heroTitle.textContent = heroTexts[currentHeroIndex].title;
        heroSubtitle.textContent = heroTexts[currentHeroIndex].subtitle;
      }

      setInterval(changeHeroText, 5000);

      document
        .getElementById("cartBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("cartPanel").classList.add("active");
        });

      document
        .getElementById("closeCart")
        .addEventListener("click", function () {
          document.getElementById("cartPanel").classList.remove("active");
        });

      function updateTotal() {
        const cartContent = document.querySelector("#cartPanel .cart-content");
        const items = cartContent.querySelectorAll(".cart-item");
        let total = 0;

        items.forEach((item) => {
          const priceText = item.querySelector("span:nth-child(3)").textContent;
          const price = parseFloat(priceText.replace("$", ""));
          total += price;
        });

        let totalElement = document.querySelector("#cart-total");
        if (!totalElement) {
          totalElement = document.createElement("div");
          totalElement.id = "cart-total";
          totalElement.style.fontWeight = "bold";
          totalElement.style.marginTop = "10px";
          cartContent.parentElement.insertBefore(
            totalElement,
            cartContent.nextSibling
          );
        }

        totalElement.textContent = `Total: $${total.toFixed(2)}`;
      }

      function add() {
        const cartContent = document.querySelector("#cartPanel .cart-content");
        const btn = event.target;
        const item = btn.closest(".menu-item");
        const name = item.querySelector("h3").textContent;
        const price = item.querySelector(".price").textContent;
        const imgSrc = item.querySelector("img").src;
        const cartItem = document.createElement("div");
        cartItem.className = "cart-item";
        cartItem.innerHTML = `
            <img src="${imgSrc}" alt="${name}" style="width:40px;height:40px;object-fit:cover;margin-right:8px;">
            <span>${name}</span>
            <span style="margin-left:auto;">${price}</span>
            <button class="remove-cart-item" style="margin-left:10px;">Remover</button>
          `;
        if (cartContent.textContent.includes("carrinho está vazio")) {
          cartContent.innerHTML = "";
        }
        cartContent.appendChild(cartItem);

        updateTotal();
      }

      document
        .querySelector("#cartPanel .cart-content")
        .addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-cart-item")) {
            const cartItem = e.target.closest(".cart-item");
            cartItem.remove();
            const cartContent = document.querySelector(
              "#cartPanel .cart-content"
            );
            if (cartContent.children.length === 0) {
              cartContent.innerHTML = "<p>Seu carrinho está vazio.</p>";
            }
            updateTotal();
          }
        });

      function updateTotal() {
        const cartContent = document.querySelector("#cartPanel .cart-content");
        const items = cartContent.querySelectorAll(".cart-item");
        let total = 0;

        items.forEach((item) => {
          const priceText = item
            .querySelector("span:nth-child(3)")
            .textContent.trim();

          // normalize string -> remove $ or R$, replace comma with dot
          const normalized = priceText
            .replace("R$", "")
            .replace("$", "")
            .replace(",", ".")
            .trim();

          const price = parseFloat(normalized);

          if (!isNaN(price)) {
            total += price;
          } else {
            console.warn("Invalid price:", priceText);
          }
        });

        let totalElement = document.querySelector("#cart-total");
        if (!totalElement) {
          totalElement = document.createElement("div");
          totalElement.id = "cart-total";
          totalElement.style.fontWeight = "bold";
          totalElement.style.marginTop = "10px";
          cartContent.parentElement.insertBefore(
            totalElement,
            cartContent.nextSibling
          );
        }

        // Format in BRL
        totalElement.textContent = `Total: ${total.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        })}`;
      }

      const originalAdd = add;
      add = function () {
        const cartContent = document.querySelector("#cartPanel .cart-content");
        const btn = event.target;
        const item = btn.closest(".menu-item");
        const name = item.querySelector("h3").textContent;
        const price = item.querySelector(".price").textContent;
        const imgSrc = item.querySelector("img").src;
        const cartItem = document.createElement("div");
        cartItem.className = "cart-item";
        cartItem.innerHTML = `
        <img src="${imgSrc}" alt="${name}" style="width:40px;height:40px;object-fit:cover;margin-right:8px;">
        <span>${name}</span>
        <span style="margin-left:auto;">${price}</span>
        <button class="remove-cart-item" style="margin-left:10px;">Remover</button>
      `;
        if (cartContent.textContent.includes("carrinho está vazio")) {
          cartContent.innerHTML = "";
        }
        cartContent.appendChild(cartItem);

        updateTotal();
      };

      document
        .querySelector("#cartPanel .cart-content")
        .addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-cart-item")) {
            const cartItem = e.target.closest(".cart-item");
            cartItem.remove();
            const cartContent = document.querySelector(
              "#cartPanel .cart-content"
            );
            if (cartContent.children.length === 0) {
              cartContent.innerHTML = "<p>Seu carrinho está vazio.</p>";
            }
            updateTotal();
          }
        });
    </script>
  </body>
</html>
